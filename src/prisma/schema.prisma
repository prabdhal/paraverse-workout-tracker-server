// backend/src/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  password      String
  name          String
  avatarUrl     String?
  bio           String?
  emailVerified Boolean       @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Relationships
  workouts      Workout[]
  programs      Program[]
  refreshTokens RefreshToken[]
  
  // Preferences (stored as JSON)
  preferences   Json?         @default("{\"theme\":\"light\",\"notifications\":true,\"metricUnits\":true}")
  
  @@map("users")
}

model RefreshToken {
  id           String   @id @default(cuid())
  token        String   @unique
  userId       String
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("refresh_tokens")
  @@index([userId])
  @@index([expiresAt])
}

model Workout {
  id            String        @id @default(cuid())
  userId        String
  name          String
  type          String        // "program" | "custom"
  startTime     DateTime
  endTime       DateTime?
  completed     Boolean       @default(false)
  tags          String[]      // ["PR", "deload", etc.]
  
  // Program tracking
  programId     String?
  programName   String?
  dayId         String?
  dayName       String?
  
  // Calculated metrics (store as JSON for flexibility)
  metrics       Json?         @default("{}")
  
  // Relationships
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercises     ExerciseLog[]
  
  @@map("workouts")
  @@index([userId])
  @@index([startTime])
  @@index([userId, startTime])
}

model ExerciseLog {
  id               String   @id @default(cuid())
  workoutId        String
  exerciseId       String
  name             String
  order            Int
  notes            String?
  
  // Program exercise tracking
  programExerciseId String?
  
  // Relationships
  workout          Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  sets             SetLog[]
  
  @@map("exercise_logs")
  @@index([workoutId])
}

model SetLog {
  id             String      @id @default(cuid())
  exerciseLogId  String
  setNumber      Int
  reps           Int
  weight         Float
  completed      Boolean     @default(true)
  rpe            Int?
  notes          String?
  
  exerciseLog    ExerciseLog @relation(fields: [exerciseLogId], references: [id], onDelete: Cascade)
  
  @@map("set_logs")
  @@index([exerciseLogId])
}

model Program {
  id           String       @id @default(cuid())
  userId       String
  name         String
  description  String?
  difficulty   String       // "beginner" | "intermediate" | "advanced"
  goal         String       // "muscle_building", "strength_training", etc.
  daysPerWeek  Int
  durationWeeks Int
  isPublic     Boolean      @default(false)
  tags         String[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  // Creator info
  creatorName  String?
  
  // Relationships
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutDays  ProgramDay[]
  
  @@map("programs")
  @@index([userId])
  @@index([isPublic])
}

model ProgramDay {
  id                String              @id @default(cuid())
  programId         String
  name              String
  description       String?
  dayNumber         Int
  order             Int
  estimatedDuration Int?
  
  program           Program             @relation(fields: [programId], references: [id], onDelete: Cascade)
  exercises         ProgramDayExercise[]
  
  @@map("program_days")
  @@index([programId])
}

model ProgramDayExercise {
  id           String    @id @default(cuid())
  programDayId String
  exerciseId   String
  name         String
  sets         Int
  repType      String    // "fixed" | "range"
  reps         Int
  maxReps      Int?
  restInterval Int       // seconds
  notes        String?
  order        Int
  
  programDay   ProgramDay @relation(fields: [programDayId], references: [id], onDelete: Cascade)
  
  @@map("program_day_exercises")
  @@index([programDayId])
}

// Shared exercise database
model Exercise {
  id                   String   @id @default(cuid())
  name                 String   @unique
  description          String?
  primaryMuscleGroup   String   // "chest", "back", etc.
  secondaryMuscleGroups String[]
  equipment            String[] // ["barbell", "dumbbell", etc.]
  category             String   // "strength", "cardio", etc.
  imageUrl             String?
  videoUrl             String?
  createdBy            String?  // null = system exercise
  isGlobal             Boolean  @default(true)
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  @@map("exercises")
  @@index([primaryMuscleGroup])
  @@index([category])
  @@index([isGlobal])
}